name: Build

on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read
  checks: write
  id-token: write

env:
  SDK_PATH: Sdk/MParticle.Maui.Sdk
  SDK_PROJECT: MParticle.Maui.Sdk
  ROKT_KIT_PATH: Kits/rokt/Sdk/MParticle.Maui.Rokt
  ROKT_KIT_PROJECT: MParticle.Maui.Kits.Rokt

jobs:
  trunk-check:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Trunk Check
        uses: trunk-io/trunk-action@4d5ecc89b2691705fd08c747c78652d2fc806a94 # v1.1.19
        with:
          check-mode: all

  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: 8.x

      - name: Setup XCode
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
        with:
          xcode-version: 16.4

      - name: Install .NET MAUI
        run: dotnet workload install maui

      - name: Restore dependencies
        run: dotnet restore

      - name: Build SDK
        run: dotnet build ${{ env.SDK_PATH }}/${{ env.SDK_PROJECT }}.csproj

      - name: Build SDK SampleApp
        run: dotnet build SampleApp/SampleApp.csproj

      - name: Pack SDK
        run: dotnet pack ${{ env.SDK_PATH }}/${{ env.SDK_PROJECT }}.csproj

      - name: Build Rokt Kit
        run: dotnet build ${{ env.ROKT_KIT_PATH }}/${{ env.ROKT_KIT_PROJECT }}.csproj

      - name: Build Rokt Kit SampleApp
        run: dotnet build Kits/rokt/SampleApp/SampleApp.csproj

      - name: Pack Rokt Kit
        run: dotnet pack ${{ env.ROKT_KIT_PATH }}/${{ env.ROKT_KIT_PROJECT }}.csproj

      - name: Find and rename SDK nupkg file
        run: |
          # Find the generated nupkg file
          NUPKG_FILE=$(find ${{ env.SDK_PATH }}/bin/Release -name "*.nupkg" | head -1)
          if [ -z "$NUPKG_FILE" ]; then
            echo "No nupkg file found"
            exit 1
          fi
          echo "Found nupkg file: $NUPKG_FILE"

          # Rename to remove version number
          RENAMED_FILE="${{ env.SDK_PATH }}/bin/Release/${{ env.SDK_PROJECT }}.nupkg"
          cp "$NUPKG_FILE" "$RENAMED_FILE"
          echo "Renamed to: $RENAMED_FILE"

      - name: Upload SDK Package Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ env.SDK_PROJECT }}.nupkg
          path: ${{ env.SDK_PATH }}/bin/Release/${{ env.SDK_PROJECT }}.nupkg

      - name: Find and rename Rokt Kit nupkg file
        run: |
          # Find the generated nupkg file
          NUPKG_FILE=$(find ${{ env.ROKT_KIT_PATH }}/bin/Release -name "*.nupkg" | head -1)
          if [ -z "$NUPKG_FILE" ]; then
            echo "No nupkg file found"
            exit 1
          fi
          echo "Found nupkg file: $NUPKG_FILE"

          # Rename to remove version number
          RENAMED_FILE="${{ env.ROKT_KIT_PATH }}/bin/Release/${{ env.ROKT_KIT_PROJECT }}.nupkg"
          cp "$NUPKG_FILE" "$RENAMED_FILE"
          echo "Renamed to: $RENAMED_FILE"

      - name: Upload Rokt Kit Package Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ env.ROKT_KIT_PROJECT }}.nupkg
          path: ${{ env.ROKT_KIT_PATH }}/bin/Release/${{ env.ROKT_KIT_PROJECT }}.nupkg

  pr-notify:
    if: >
      github.event_name == 'pull_request' &&
      github.event.pull_request.draft == false
    needs: [trunk-check, build]
    name: Notify GChat
    uses: ROKT/rokt-workflows/.github/workflows/oss_pr_opened_notification.yml@main
    secrets:
      gchat_webhook: ${{ secrets.GCHAT_PRS_WEBHOOK }}
