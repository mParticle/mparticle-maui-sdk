name: Release .NET MAUI SDK

on:
  push:
    branches:
      - main
    paths:
      - VERSION

permissions:
  contents: write

jobs:
  setup-and-version:
    runs-on: ubuntu-latest
    outputs:
      final_version: ${{ steps.version-file.outputs.release-version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check if VERSION file changed
        id: version-changed
        uses: tj-actions/changed-files@2f7c5bfce28377bc069a65ba478de0a74aa0ca32 # v46.0.1
        with:
          files: VERSION

      - name: Get current version
        id: version-file
        run: |
          version_from_file=$(head -n 1 VERSION)
          echo "release-version=$version_from_file" >> $GITHUB_OUTPUT

  build-and-release:
    needs: setup-and-version
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: 8.x

      - name: Setup XCode
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
        with:
          xcode-version: 16.4

      - name: Install .NET MAUI
        run: dotnet workload install maui

      - name: Restore dependencies
        run: dotnet restore

      - name: Build SDK
        run: dotnet build Sdk/MParticle.Maui.Sdk/MParticle.Maui.Sdk.csproj -c Release

      - name: Pack SDK
        run: dotnet pack Sdk/MParticle.Maui.Sdk/MParticle.Maui.Sdk.csproj -c Release

      - name: Publish to NuGet Gallery
        run: dotnet nuget push Sdk/MParticle.Maui.Sdk/bin/Release/MParticle.Maui.Sdk.${{ needs.setup-and-version.outputs.final_version }}.nupkg --source https://api.nuget.org/v3/index.json --api-key ${{ secrets.NUGET_API_KEY }}

      - name: Upload Package Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: MParticle.Maui.Sdk.${{ needs.setup-and-version.outputs.final_version }}.nupkg
          path: Sdk/MParticle.Maui.Sdk/bin/Release/MParticle.Maui.Sdk.${{ needs.setup-and-version.outputs.final_version }}.nupkg

      - uses: ffurrer2/extract-release-notes@9989ccec43d726ef05aa1cd7b2854fb96b6df6ab # v2.2.0
        id: extract-release-notes
        with:
          changelog_file: CHANGELOG.md

      - name: Changelog
        run: echo "${{ steps.extract-release-notes.outputs.release_notes }}"

      - name: Create Github release
        uses: ncipollo/release-action@440c8c1cb0ed28b9f43e4d1d670870f059653174 # v1.16.0
        with:
          artifacts: Sdk/MParticle.Maui.Sdk/bin/Release/MParticle.Maui.Sdk.${{ needs.setup-and-version.outputs.final_version }}.nupkg
          makeLatest: true
          tag: ${{ needs.setup-and-version.outputs.final_version }}
          body: |
            ## Release notes:
            ${{ steps.extract-release-notes.outputs.release_notes }}
